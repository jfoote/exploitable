## Makefile for building triage test binaries.
## The explicitly declared file targets below may cause Makefile warnings
## due to redefinition -- this is a known issue. They may safely be ignored.
BIN_DIR=./bin
TEST_FILE_EXT=.test

CC=gcc
CPPC=g++

C_SRC=$(wildcard *.c)
CPP_SRC=$(wildcard *.cpp)

C_TESTS=$(C_SRC:.c=$(TEST_FILE_EXT))
CPP_TESTS=$(CPP_SRC:.cpp=$(TEST_FILE_EXT))
TESTS=$(C_TESTS) $(CPP_TESTS)

all: $(TESTS)

$(TESTS): | $(BIN_DIR)

$(BIN_DIR):
	mkdir $(BIN_DIR)

$(C_TESTS): %$(TEST_FILE_EXT): %.c
	$(CC) -o $(BIN_DIR)/$@ $<

$(CPP_TESTS): %$(TEST_FILE_EXT): %.cpp
	$(CPPC) -o $(BIN_DIR)/$@ $<

testStackCodeExecution.test: %$(TEST_FILE_EXT): %.c
	${CC} -o $(BIN_DIR)/$@ $<
	execstack -s $(BIN_DIR)/$@

testStackBufferOverflow.test: %$(TEST_FILE_EXT): %.c
	${CC} -fstack-protector-all -o $(BIN_DIR)/$@ $<

testReturnAv.test: %$(TEST_FILE_EXT): %.c
	${CC} -fno-stack-protector -o $(BIN_DIR)/$@ $<

testTemplateNamespace.test: %$(TEST_FILE_EXT): %.cpp
	${CPPC} -o $(BIN_DIR)/$@ $< -g -std=c++11

.PHONY: clean
clean:
	-rm $(addprefix $(BIN_DIR)/,$(TESTS))
	-rmdir $(BIN_DIR)
